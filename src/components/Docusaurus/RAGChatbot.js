import React, { useState, useEffect } from 'react';
import ChatInterface from '../Chatbot/ChatInterface';
import '../../css/custom.css';

const RAGChatbot = () => {
  const [sessionId, setSessionId] = useState('');
  const [isVisible, setIsVisible] = useState(false);
  const [selectedText, setSelectedText] = useState('');

  // Initialize session
  useEffect(() => {
    // Try to get session from localStorage
    const storedSessionId = localStorage.getItem('ragChatSessionId');
    if (storedSessionId) {
      setSessionId(storedSessionId);
    }
  }, []);

  // Handle session changes
  const handleSessionChange = (newSessionId) => {
    setSessionId(newSessionId);
    localStorage.setItem('ragChatSessionId', newSessionId);
  };

  // Handle text selection
  useEffect(() => {
    const handleSelection = () => {
      const selectedText = window.getSelection()?.toString().trim();
      if (selectedText) {
        setSelectedText(selectedText);
      }
    };

    document.addEventListener('mouseup', handleSelection);
    return () => {
      document.removeEventListener('mouseup', handleSelection);
    };
  }, []);

  const toggleChat = () => {
    setIsVisible(!isVisible);
  };

  return (
    <div className="rag-chatbot-container">
      {isVisible ? (
        <div className="chat-interface">
          <div className="chat-header">
            <span>Textbook Assistant</span>
            <button className="chat-close-btn" onClick={toggleChat}>Ã—</button>
          </div>
          <ChatInterface
            sessionId={sessionId}
            onSessionChange={handleSessionChange}
          />
        </div>
      ) : (
        <button className="chat-floating-button" onClick={toggleChat}>
          <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
            <path d="M21 6V8C21.0011 9.51691 20.3121 10.9588 19.0989 11.9529C17.8858 12.9471 16.2685 13.3776 14.7 13.1C14.7 13.1 14.19 13.01 13.9 13.29C13.61 13.57 13.69 14.08 13.7 14.29C13.8857 15.3404 13.6428 16.4137 13.013 17.3163C12.3833 18.2189 11.4056 18.8727 10.29 19.15C9.17442 19.4273 7.99782 19.3005 6.99891 18.7945C6.00001 18.2885 5.24828 17.439 4.89889 16.4102C4.54951 15.3814 4.62962 14.2548 5.12 13.29C4.0599 12.35 3.4101 10.94 3.41 9.4V6C3.4101 4.4499 3.9804 2.9615 4.99 1.84C5.9997 0.7195 7.37 0.03 8.86 0H15.13C16.62 0.03 17.9903 0.7195 18.9999 1.84C20.0096 2.9615 20.5799 4.4499 20.58 6V8C20.58 9.1878 20.108 10.3271 19.26 11.17C18.412 12.0129 17.2728 12.48 16.085 12.48C14.8972 12.48 13.758 12.0129 12.91 11.17C12.062 10.3271 11.59 9.1878 11.59 8V6C11.59 5.2043 11.2739 4.4413 10.71 3.8787C10.1461 3.316 9.3827 2.99 8.58 2.99C7.7773 2.99 7.0139 3.316 6.45 3.8787C5.8861 4.4413 5.57 5.2043 5.57 6V9.4C5.57 10.39 5.93 11.34 6.57 12.06C7.21 12.78 8.09 13.21 9 13.29C9.29 13.01 9.79 13.1 9.79 13.1C10.95 13.32 12 13.94 12.71 14.85C13.42 15.76 13.72 16.87 13.55 17.97C13.38 19.07 12.75 20.06 11.79 20.75C10.83 21.44 9.61 21.77 8.4 21.67C7.19 21.57 6.07 21.06 5.29 20.24C4.51 19.42 4.13 18.35 4.23 17.25C4.33 16.15 4.89 15.14 5.8 14.49C5.8 14.49 6.31 14.58 6.6 14.3C6.89 14.02 6.81 13.51 6.8 13.3C6.6143 12.25 6.8572 11.1767 7.487 10.2741C8.1167 9.3715 9.0944 8.7177 10.21 8.44C11.3256 8.1623 12.5022 8.2891 13.5011 8.7951C14.5 9.301 15.2517 10.1505 15.59 11.18C15.9283 12.2095 15.8482 13.3361 16.19 14.29C16.19 14.29 16.11 14.8 16.4 15.08C16.69 15.36 17.2 15.28 17.41 15.29C18.4601 15.29 19.47 14.88 20.23 14.14C20.99 13.4 21.44 12.38 21.49 11.29C21.54 10.2 21.18 9.12 20.48 8.29C19.78 7.46 18.78 6.94 17.7 6.82C16.62 6.7 15.53 7 14.68 7.62C13.83 8.24 13.29 9.13 13.17 10.11C13.05 11.09 13.36 12.07 14 12.79C14.64 13.51 15.59 13.9 16.58 13.85C17.57 13.8 18.48 13.32 19.11 12.5C19.74 11.68 20.04 10.6 20 9.49V6C20.0011 5.2086 19.7774 4.433 19.35 3.7574C18.9226 3.0817 18.3055 2.5352 17.5672 2.1784C16.8289 1.8216 15.995 1.6728 15.1614 1.751C14.3278 1.8292 13.5243 2.1306 12.8445 2.6249C12.1647 3.1192 11.6346 3.787 11.318 4.5564C11.0014 5.3258 10.9116 6.1645 11.0592 6.9767C11.2068 7.7889 11.5847 8.539 12.15 9.14C12.7153 9.741 13.4474 10.1658 14.25 10.36C14.46 10.41 14.67 10.44 14.88 10.44C15.33 10.44 15.77 10.3 16.15 10.04C16.53 9.78 16.83 9.41 16.99 8.98C17.15 8.55 17.16 8.08 17.02 7.64C16.88 7.2 16.61 6.82 16.25 6.56C15.89 6.3 15.46 6.18 15.04 6.22C14.62 6.26 14.24 6.46 13.97 6.77C13.7 7.08 13.56 7.48 13.58 7.89C13.6 8.3 13.78 8.68 14.08 8.95C14.38 9.22 14.77 9.36 15.17 9.34C15.27 9.34 15.37 9.32 15.47 9.28C15.57 9.24 15.66 9.18 15.74 9.1C15.82 9.02 15.88 8.93 15.92 8.83C15.96 8.73 15.98 8.62 15.98 8.51C15.98 8.4 15.96 8.29 15.92 8.19C15.88 8.09 15.82 8 15.74 7.92C15.66 7.84 15.57 7.78 15.47 7.74C15.37 7.7 15.27 7.68 15.17 7.68C14.97 7.68 14.78 7.72 14.6 7.8C14.42 7.88 14.27 8 14.15 8.15C14.03 8.3 13.95 8.47 13.92 8.65C13.89 8.83 13.91 9.01 13.97 9.18C14.03 9.35 14.14 9.49 14.28 9.6C14.42 9.71 14.59 9.78 14.77 9.8C14.95 9.82 15.13 9.79 15.29 9.72C15.45 9.65 15.58 9.54 15.67 9.4C15.76 9.26 15.8 9.1 15.79 8.94C15.78 8.78 15.72 8.63 15.63 8.5C15.54 8.37 15.41 8.27 15.27 8.2C15.13 8.13 14.97 8.1 14.81 8.11C14.65 8.12 14.5 8.17 14.36 8.26C14.22 8.35 14.11 8.47 14.04 8.61C13.97 8.75 13.94 8.9 13.95 9.05C13.96 9.2 14.01 9.35 14.1 9.48C14.19 9.61 14.31 9.71 14.45 9.78C14.59 9.85 14.75 9.88 14.91 9.87C15.07 9.86 15.22 9.81 15.35 9.73C15.48 9.65 15.58 9.54 15.64 9.41C15.7 9.28 15.72 9.14 15.7 9.01C15.68 8.88 15.62 8.75 15.53 8.65C15.44 8.55 15.32 8.47 15.19 8.43C15.06 8.39 14.92 8.39 14.79 8.43C14.66 8.47 14.54 8.54 14.45 8.64C14.36 8.74 14.3 8.86 14.28 8.99C14.26 9.12 14.28 9.25 14.33 9.37C14.38 9.49 14.47 9.59 14.58 9.66C14.69 9.73 14.82 9.77 14.95 9.77C15.08 9.77 15.21 9.73 15.32 9.66C15.43 9.59 15.52 9.49 15.57 9.37C15.62 9.25 15.63 9.12 15.6 8.99C15.57 8.86 15.5 8.75 15.41 8.67C15.32 8.59 15.21 8.54 15.09 8.53C14.97 8.52 14.85 8.55 14.75 8.61C14.65 8.67 14.57 8.76 14.52 8.86C14.47 8.96 14.46 9.07 14.49 9.18C14.52 9.29 14.58 9.39 14.67 9.47C14.76 9.55 14.87 9.6 14.99 9.61C15.11 9.62 15.23 9.59 15.33 9.53C15.43 9.47 15.51 9.38 15.55 9.28C15.59 9.18 15.6 9.07 15.57 8.96C15.54 8.85 15.48 8.75 15.4 8.68C15.32 8.61 15.22 8.56 15.12 8.55C15.02 8.54 14.91 8.56 14.82 8.61C14.73 8.66 14.65 8.74 14.6 8.83C14.55 8.92 14.53 9.02 14.54 9.12C14.55 9.22 14.6 9.32 14.67 9.39C14.74 9.46 14.83 9.51 14.93 9.52C15.03 9.53 15.13 9.5 15.21 9.45C15.29 9.4 15.35 9.32 15.38 9.23C15.41 9.14 15.4 9.04 15.36 8.96C15.32 8.88 15.26 8.81 15.18 8.77C15.1 8.73 15.01 8.72 14.93 8.74C14.85 8.76 14.77 8.81 14.71 8.88C14.65 8.95 14.62 9.04 14.62 9.13C14.62 9.22 14.65 9.31 14.71 9.38C14.77 9.45 14.85 9.5 14.94 9.52C15.03 9.54 15.12 9.52 15.2 9.47C15.28 9.42 15.33 9.35 15.36 9.26C15.39 9.17 15.38 9.07 15.34 8.99C15.3 8.91 15.24 8.84 15.16 8.8C15.08 8.76 14.99 8.75 14.9 8.77C14.81 8.79 14.73 8.84 14.67 8.91C14.61 8.98 14.58 9.07 14.58 9.16C14.58 9.25 14.61 9.34 14.67 9.41C14.73 9.48 14.81 9.53 14.9 9.55C14.99 9.57 15.08 9.55 15.16 9.5C15.24 9.45 15.29 9.38 15.31 9.29C15.33 9.2 15.31 9.11 15.27 9.03C15.23 8.95 15.17 8.89 15.09 8.86C15.01 8.83 14.92 8.83 14.84 8.86C14.76 8.89 14.69 8.95 14.65 9.03C14.61 9.11 14.6 9.2 14.63 9.29C14.66 9.38 14.72 9.45 14.79 9.5C14.86 9.55 14.95 9.57 15.04 9.55C15.13 9.53 15.2 9.48 15.24 9.4C15.28 9.32 15.29 9.23 15.26 9.15C15.23 9.07 15.18 9.01 15.11 8.97C15.04 8.93 14.95 8.92 14.87 8.94C14.79 8.96 14.72 9.01 14.67 9.08C14.62 9.15 14.6 9.24 14.61 9.33C14.62 9.42 14.66 9.5 14.72 9.56C14.78 9.62 14.86 9.66 14.95 9.67C15.04 9.68 15.13 9.65 15.2 9.6C15.27 9.55 15.31 9.48 15.32 9.39C15.33 9.3 15.3 9.21 15.25 9.14C15.2 9.07 15.13 9.02 15.05 9C14.97 8.98 14.88 8.99 14.81 9.03C14.74 9.07 14.68 9.14 14.65 9.22C14.62 9.3 14.62 9.39 14.65 9.47C14.68 9.55 14.74 9.62 14.82 9.66C14.9 9.7 14.99 9.7 15.07 9.67C15.15 9.64 15.21 9.58 15.25 9.5C15.29 9.42 15.29 9.33 15.26 9.25C15.23 9.17 15.18 9.1 15.11 9.06C15.04 9.02 14.95 9 14.87 9.01C14.79 9.02 14.71 9.06 14.65 9.13C14.59 9.2 14.56 9.29 14.56 9.38C14.56 9.47 14.59 9.56 14.65 9.63C14.71 9.7 14.79 9.74 14.88 9.75C14.97 9.76 15.06 9.73 15.13 9.68C15.2 9.63 15.25 9.56 15.26 9.47C15.27 9.38 15.25 9.29 15.2 9.22C15.15 9.15 15.08 9.1 15 9.09C14.92 9.08 14.83 9.1 14.76 9.15C14.69 9.2 14.64 9.28 14.62 9.37C14.6 9.46 14.61 9.55 14.65 9.63C14.69 9.71 14.76 9.77 14.84 9.8C14.92 9.83 15.01 9.83 15.09 9.8C15.17 9.77 15.23 9.71 15.26 9.63C15.29 9.55 15.29 9.46 15.26 9.38C15.23 9.3 15.17 9.24 15.09 9.21C15.01 9.18 14.92 9.18 14.84 9.21C14.76 9.24 14.69 9.3 14.65 9.38C14.61 9.46 14.6 9.55 14.63 9.64C14.66 9.73 14.72 9.8 14.8 9.84C14.88 9.88 14.97 9.89 15.06 9.87C15.15 9.85 15.22 9.8 15.27 9.73C15.32 9.66 15.33 9.57 15.31 9.48C15.29 9.39 15.24 9.32 15.17 9.27C15.1 9.22 15.01 9.2 14.92 9.21C14.83 9.22 14.75 9.26 14.68 9.33C14.61 9.4 14.57 9.49 14.57 9.59C14.57 9.69 14.6 9.78 14.66 9.86C14.72 9.94 14.8 9.99 14.89 1C14.98 1.001 15.07 0.98 15.15 0.94C15.23 0.9 15.29 0.84 15.33 0.77C15.37 0.7 15.38 0.62 15.36 0.54C15.34 0.46 15.3 0.39 15.24 0.34C15.18 0.29 15.11 0.26 15.03 0.26C14.95 0.26 14.87 0.28 14.8 0.33C14.73 0.38 14.68 0.45 14.65 0.53C14.62 0.61 14.62 0.7 14.65 0.78C14.68 0.86 14.74 0.93 14.82 0.97C14.9 1.01 14.99 1.02 15.07 1C15.15 0.98 15.22 0.93 15.26 0.86C15.3 0.79 15.31 0.7 15.29 0.62C15.27 0.54 15.22 0.47 15.15 0.43C15.08 0.39 15 0.38 14.92 0.4C14.84 0.42 14.77 0.47 14.72 0.54C14.67 0.61 14.65 0.7 14.67 0.79C14.69 0.88 14.74 0.95 14.81 0.99C14.88 1.03 14.96 1.04 15.04 1.02C15.12 1 15.18 0.95 15.22 0.88C15.26 0.81 15.27 0.72 15.24 0.64C15.21 0.56 15.16 0.49 15.08 0.45C15 0.41 14.91 0.4 14.83 0.42C14.75 0.44 14.68 0.49 14.63 0.56C14.58 0.63 14.56 0.72 14.57 0.81C14.58 0.9 14.62 0.98 14.68 1.04C14.74 1.1 14.82 1.13 14.91 1.13C15 1.13 15.08 1.1 15.15 1.05C15.22 1 15.26 0.93 15.27 0.84C15.28 0.75 15.26 0.66 15.21 0.59C15.16 0.52 15.09 0.47 15.01 0.45C14.93 0.43 14.84 0.44 14.77 0.48C14.7 0.52 14.64 0.59 14.61 0.67C14.58 0.75 14.58 0.84 14.61 0.92C14.64 1 14.7 1.06 14.78 1.09C14.86 1.12 14.95 1.12 15.03 1.09C15.11 1.06 15.17 1 15.21 0.92C15.25 0.84 15.26 0.75 15.23 0.66C15.2 0.57 15.14 0.5 15.06 0.46C14.98 0.42 14.89 0.41 14.8 0.43C14.71 0.45 14.64 0.5 14.59 0.58C14.54 0.66 14.52 0.75 14.53 0.84C14.54 0.93 14.58 1.01 14.64 1.07C14.7 1.13 14.78 1.16 14.87 1.16C14.96 1.16 15.04 1.13 15.1 1.07C15.16 1.01 15.19 0.92 15.19 0.83C15.19 0.74 15.16 0.65 15.1 0.59C15.04 0.53 14.96 0.5 14.87 0.5C14.78 0.5 14.69 0.53 14.63 0.59C14.57 0.65 14.54 0.74 14.54 0.83C14.54 0.92 14.57 1.01 14.63 1.07C14.69 1.13 14.78 1.16 14.87 1.16C14.96 1.16 15.05 1.13 15.11 1.07C15.17 1.01 15.2 0.92 15.2 0.83C15.2 0.74 15.17 0.65 15.11 0.59C15.05 0.53 14.96 0.5 14.87 0.5Z" />
          </svg>
        </button>
      )}
    </div>
  );
};

export default RAGChatbot;